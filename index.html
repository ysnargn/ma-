<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depoda Saklanan Masa Canavarları (Özelleştirilebilir Başlık)</title>
    <!-- Tailwind CSS (Tasarım için) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (İkonlar için) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #0f172a; /* Koyu Lacivert */
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        /* SARI TEMA - Canavar temasına hafif bir uyum */
        .tt-gradient {
            background: linear-gradient(90deg, #ca8a04 0%, #facc15 50%, #ca8a04 100%);
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Tablo satır hover efekti */
        tr:hover td {
            background-color: rgba(59, 130, 246, 0.1);
        }
        /* Skor inputları */
        input[type=number] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Özel kaydırma çubuğu */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
    </style>
</head>
<body class="min-h-screen p-2 md:p-6" onload="initApp()">

    <!-- Ayarlar Butonu (Sol Üst Köşe - Sabit ve Her Zaman Görünür) -->
    <div class="fixed top-4 left-4 z-50" id="settings-button-wrapper">
        <button onclick="showSettingsModal()" class="w-12 h-12 rounded-full bg-slate-700 text-white shadow-xl hover:bg-blue-600 transition-colors flex items-center justify-center border border-slate-600">
            <i class="fas fa-cog text-xl"></i>
        </button>
    </div>

    <div class="max-w-4xl mx-auto space-y-6">
        
        <!-- Başlık Alanı (SARI TEMA) -->
        <div class="text-center py-8 relative overflow-hidden rounded-2xl shadow-2xl tt-gradient border border-yellow-700/50">
            <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
            <div class="relative z-10">
                <!-- MASA TENİSİ İKONU -->
                <i class="fas fa-table-tennis text-5xl text-gray-800 mb-2 drop-shadow-lg animate-pulse"></i>
                <!-- BAŞLIK METNİ -->
                <h1 id="app-title" class="text-2xl md:text-3xl font-extrabold tracking-wider text-gray-900 drop-shadow-md uppercase">
                    DEPODA SAKLANAN MASA CANAVARLARI (TEKLER LİGİ)
                </h1>
                <span id="mode-display" class="text-xs text-gray-700 font-bold mt-1 block">TEKLER LİGİ</span>
            </div>
        </div>

        <!-- Menü Butonları -->
        <div class="flex rounded-lg bg-slate-800 p-1 shadow-lg" id="menu-buttons">
            <button onclick="showTab('standings')" id="btn-standings" class="flex-1 py-3 rounded-md transition-all font-bold bg-blue-600 text-white shadow-md">
                <i class="fas fa-list-ol mr-2"></i> Canavar Sıralaması
            </button>
            <button onclick="showTab('fixtures')" id="btn-fixtures" class="flex-1 py-3 rounded-md transition-all font-bold text-slate-400 hover:text-white hover:bg-slate-700">
                <i class="fas fa-calendar-alt mr-2"></i> Maç Fikstürü
            </button>
        </div>

        <!-- İÇERİK ALANI -->
        <div class="glass-panel rounded-xl shadow-2xl overflow-hidden min-h-[500px] p-4 md:p-6">
            
            <!-- SEKMESİ: PUAN DURUMU -->
            <div id="tab-standings" class="p-0">
                <div id="standings-content" class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-900/80 text-blue-300 text-xs uppercase tracking-wider border-b border-slate-700">
                                <th class="p-4 text-center w-12">#</th>
                                <th class="p-4" id="standings-entity-title">Canavar</th>
                                <th class="p-4 text-center" title="Oynanan Maç">O</th>
                                <th class="p-4 text-center hidden sm:table-cell" title="Galibiyet">G</th>
                                <th class="p-4 text-center hidden sm:table-cell" title="Beraberlik">B</th>
                                <th class="p-4 text-center hidden sm:table-cell" title="Mağlubiyet">M</th>
                                <th class="p-4 text-center hidden sm:table-cell" title="Attığı Gol">A</th>
                                <th class="p-4 text-center hidden md:table-cell" title="Yediği Gol">Y</th>
                                <th class="p-4 text-center" title="Averaj">AV</th>
                                <th class="p-4 text-center font-bold text-white bg-blue-900/30 text-lg">P</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body" class="divide-y divide-slate-700 text-sm md:text-base">
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SEKMESİ: FİKSTÜR (HAFTALIK GÖSTERİM) -->
            <div id="tab-fixtures" class="hidden p-0 space-y-6">
                <!-- Hafta Navigasyonu -->
                <div class="flex items-center justify-between p-2 rounded-lg bg-slate-900/50 shadow-lg border border-slate-700">
                    <button id="prev-round-btn" onclick="changeRound(-1)" class="p-2 text-blue-400 hover:text-blue-200 disabled:text-slate-600 disabled:cursor-not-allowed transition-colors rounded-full hover:bg-slate-700/50">
                        <i class="fas fa-chevron-left text-xl"></i>
                    </button>
                    <h3 id="round-title" class="text-center text-blue-400 font-bold uppercase tracking-widest text-lg md:text-xl">
                        1. Hafta
                    </h3>
                    <button id="next-round-btn" onclick="changeRound(1)" class="p-2 text-blue-400 hover:text-blue-200 disabled:text-slate-600 disabled:cursor-not-allowed transition-colors rounded-full hover:bg-slate-700/50">
                        <i class="fas fa-chevron-right text-xl"></i>
                    </button>
                </div>

                <div id="fixtures-container" class="p-2 md:p-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                    <!-- JS ile sadece geçerli haftanın maçları doldurulacak -->
                </div>
            </div>
            
        </div>

    </div>
    
    <!-- ÖZEL ONAY MODALI (CONFIRM YERİNE) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm transition-opacity" onclick="closeModal()">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-blue-400/30" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-blue-400">Onay Gerekiyor</h3>
            <p id="modal-message" class="text-sm text-slate-300 mb-6">Emin misiniz?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal(false)" class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors">
                    İptal
                </button>
                <button id="modal-confirm-button" onclick="closeModal(true)" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors">
                    Onayla
                </button>
            </div>
        </div>
    </div>
    
    <!-- AYARLAR MODALI -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[55] flex items-center justify-center bg-black/70 backdrop-blur-sm transition-opacity" onclick="closeSettingsModal()">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-xl w-full h-[90vh] md:h-auto md:max-h-[90vh] flex flex-col border border-blue-400/30" onclick="event.stopPropagation()">
            
            <!-- Başlık ve Kapatma -->
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700 sticky top-0 bg-slate-800 z-10">
                <h2 class="text-2xl font-bold text-blue-400">Canavar Yönetimi ve Fikstür Ayarları</h2>
                <button onclick="closeSettingsModal()" class="text-slate-400 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- İçerik -->
            <div class="space-y-8 flex-grow overflow-y-auto custom-scrollbar pr-2">

                <!-- Mesaj Kutusu -->
                <div id="settings-message-container">
                    <p id="settings-message" class="text-sm text-center font-medium"></p>
                </div>

                <!-- UYGULAMA BAŞLIĞI AYARI -->
                <div class="bg-slate-900/50 p-4 rounded-lg shadow-inner space-y-3 border border-yellow-700/50">
                    <h3 class="text-xl font-semibold text-yellow-400">Uygulama Başlığını Düzenle</h3>
                    <input type="text" id="app-custom-title" placeholder="Yeni lig başlığı" 
                           class="w-full p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:border-yellow-500 outline-none"
                           onchange="saveCustomTitle(this.value)">
                    <p class="text-xs text-slate-400">Başlık, tüm uygulamanın üst kısmında görünür.</p>
                </div>
                
                <!-- Oyuncu Ekleme -->
                <div class="bg-slate-900/50 p-4 rounded-lg shadow-inner space-y-4 border border-slate-700">
                    <h3 class="text-xl font-semibold text-white">Canavar Ekle (Tekler İçin)</h3>
                    <div class="flex flex-col gap-3">
                        <input type="text" id="new-player-name" placeholder="Yeni canavar adı" 
                               class="flex-grow p-3 rounded-lg bg-slate-700 text-white border border-slate-600 focus:border-blue-500 outline-none">
                    </div>
                    <button onclick="handleAddPlayer()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Canavar Ekle
                    </button>
                </div>

                <!-- Oyuncu Yönetimi -->
                <div class="bg-slate-900/50 p-4 rounded-lg shadow-inner space-y-4 border border-slate-700">
                    <h3 class="text-xl font-semibold text-white" id="player-count-display">Mevcut Canavarlar (0)</h3>
                    <p id="player-warning" class="text-yellow-400 text-sm hidden">Uyarı: Çiftli turnuva için çift sayıda (min 4) canavar gerekir.</p>
                    <ul id="player-list-container" class="space-y-3 max-h-48 overflow-y-auto pr-2">
                        <!-- JS ile doldurulacak -->
                    </ul>
                </div>

                <!-- MOD DEĞİŞTİRME BUTONLARI -->
                <div id="mode-switch-section">
                    <!-- TEKLER LİGİNDEYKEN GÖRÜNÜR -->
                    <div id="doubles-start-section" class="bg-purple-900/30 p-4 rounded-lg shadow-inner space-y-4 border border-purple-700">
                        <h3 class="text-xl font-semibold text-purple-400">Çiftli Turnuva Başlat</h3>
                        <button onclick="startDoublesTournamentConfirmation()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                            <i class="fas fa-users mr-2"></i> Çiftli Turnuvaya Dön
                        </button>
                        <p class="text-sm text-purple-300 pt-2">Mevcut skorlara göre canavarları (1. vs son, 2. vs sondan bir önceki) eşleştirir, takımları kurar ve yeni bir **takım lig fikstürü** oluşturur. Mevcut skorlar silinir.</p>
                    </div>

                    <!-- ÇİFTLER LİGİNDEYKEN GÖRÜNÜR -->
                    <div id="singles-start-section" class="bg-blue-900/30 p-4 rounded-lg shadow-inner space-y-4 border border-blue-700 hidden">
                        <h3 class="text-xl font-semibold text-blue-400">Tekler Ligi'ne Geri Dön</h3>
                        <button onclick="startSinglesTournamentConfirmation()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                            <i class="fas fa-user mr-2"></i> Tekler Ligi'ne Geç
                        </button>
                        <p class="text-sm text-blue-300 pt-2">Bu işlem, mevcut takımları ve Çiftler Ligi skorlarını silerek, canavarları tekrar bireysel oyuncu haline getirir ve yeni bir **Tekler Ligi fikstürü** oluşturur.</p>
                    </div>
                </div>

                <!-- FİKSTÜR YENİLEME BUTONU -->
                <div class="bg-slate-900/50 p-4 rounded-lg shadow-inner space-y-4 border border-slate-700" id="reset-fixtures-section">
                    <h3 class="text-xl font-semibold text-white" id="singles-reset-title">Tekler Ligi Fikstürünü Yenile</h3>
                    <button onclick="resetFixturesConfirmation()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <i class="fas fa-redo-alt mr-2"></i> Yeni Fikstür Çek
                    </button>
                    <p class="text-sm text-slate-400 pt-2">Bu işlem, mevcut skorları tamamen siler ve rastgele bir fikstür oluşturur.</p>
                </div>

                <!-- TÜMÜNÜ SIFIRLA -->
                <div class="bg-red-900/20 p-4 rounded-lg shadow-inner space-y-4 border border-red-700">
                    <h3 class="text-xl font-semibold text-red-400">Tüm Depoyu Sıfırla</h3>
                    <button onclick="resetLeagueConfirmation()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                        <i class="fas fa-trash-alt mr-2"></i> Tüm Verileri Sil (Canavarlar Dahil)
                    </button>
                    <p class="text-sm text-red-300 text-center">Bu işlem, yerel depolamadan *tüm* verileri kalıcı olarak silecektir.</p>
                </div>
            </div>
        </div>
    </div>


    <!-- JAVASCRIPT KODLARI -->
    <script>
        // Global Veri Yapıları (LocalStorage'dan yüklenir/kaydedilir)
        let players = []; // {id, name} - Bireysel oyuncular
        let teams = []; // {id, name, player1Name, player2Name} - Çiftler takımları
        let isDoublesMode = false; // Uygulamanın Tekler (false) mı Çiftler (true) modunda olduğunu tutar
        let matches = []; // {id, round, home: Team/Player Name, away: Team/Player Name, homeScore, awayScore}
        let currentRound = 1; 
        let totalRounds = 0; 
        let customTitle = "DEPODA SAKLANAN MASA CANAVARLARI"; // Varsayılan Başlık
        let currentCallback = null;
        let sortedPlayers = []; // Puan durumuna göre sıralanmış liste (Tekler veya Çiftler)
        
        // ---------- LOCALSTORAGE İŞLEMLERİ ----------

        function saveState() {
            localStorage.setItem('players', JSON.stringify(players));
            localStorage.setItem('teams', JSON.stringify(teams));
            localStorage.setItem('isDoublesMode', JSON.stringify(isDoublesMode));
            localStorage.setItem('matches', JSON.stringify(matches));
            localStorage.setItem('currentRound', currentRound);
            localStorage.setItem('totalRounds', totalRounds);
            localStorage.setItem('customTitle', customTitle); // Başlığı kaydet
            console.log("State Kaydedildi. Çiftler Modu:", isDoublesMode);
        }

        function loadData() {
            try {
                const loadedPlayers = localStorage.getItem('players');
                players = loadedPlayers ? JSON.parse(loadedPlayers) : [];
                players.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
            } catch (e) {
                console.error("Oyuncu verisi yüklenirken hata:", e);
                players = [];
            }
            
            try {
                const loadedTeams = localStorage.getItem('teams');
                teams = loadedTeams ? JSON.parse(loadedTeams) : [];
            } catch (e) { teams = []; }
            
            try {
                const loadedMode = localStorage.getItem('isDoublesMode');
                isDoublesMode = loadedMode ? JSON.parse(loadedMode) : false;
            } catch (e) { isDoublesMode = false; }
            
            try {
                const loadedMatches = localStorage.getItem('matches');
                matches = loadedMatches ? JSON.parse(loadedMatches) : [];
                
                matches.sort((a, b) => {
                    if (a.round !== b.round) return a.round - b.round;
                    return a.home.localeCompare(b.home, 'tr');
                });
                
                totalRounds = matches.length > 0 ? matches[matches.length - 1].round : 0;
            } catch (e) {
                console.error("Maç verisi yüklenirken hata:", e);
                matches = [];
                totalRounds = 0;
            }

            customTitle = localStorage.getItem('customTitle') || "DEPODA SAKLANAN MASA CANAVARLARI"; // Başlığı yükle
            currentRound = parseInt(localStorage.getItem('currentRound')) || 1;
            totalRounds = parseInt(localStorage.getItem('totalRounds')) || totalRounds;

            // Mode'a göre başlık güncelleme
            updateAppTitle();
        }
        
        function updateAppTitle() {
            const titleEl = document.getElementById('app-title');
            const modeDisplayEl = document.getElementById('mode-display');
            const entityTitleEl = document.getElementById('standings-entity-title');
            
            // Ayarlar Modal'ındaki mod değiştirme butonlarının görünürlüğünü ayarla
            const doublesStart = document.getElementById('doubles-start-section');
            const singlesStart = document.getElementById('singles-start-section');
            
            // Ana Başlık (Özelleştirilmiş + Mod)
            titleEl.textContent = customTitle.toUpperCase();

            if (isDoublesMode) {
                modeDisplayEl.textContent = "ÇİFTLER LİGİ";
                entityTitleEl.textContent = "Takım";
                
                if (doublesStart) doublesStart.classList.add('hidden');
                if (singlesStart) singlesStart.classList.remove('hidden');

            } else {
                modeDisplayEl.textContent = "TEKLER LİGİ";
                entityTitleEl.textContent = "Canavar";

                if (doublesStart) doublesStart.classList.remove('hidden');
                if (singlesStart) singlesStart.classList.add('hidden');
            }
            
            // Fikstür yenileme başlığını güncelle
            const singlesResetTitle = document.getElementById('singles-reset-title');
            if (singlesResetTitle) {
                singlesResetTitle.textContent = isDoublesMode ? "Çiftler Fikstürünü Yenile" : "Tekler Ligi Fikstürünü Yenile";
            }
            
            // Ayarlar modalındaki input'u güncelle (Açılışta doğru değeri göstermek için)
            const customTitleInput = document.getElementById('app-custom-title');
            if (customTitleInput) {
                customTitleInput.value = customTitle;
            }
        }
        
        // YENİ FONKSİYON: Kullanıcının girdiği başlığı kaydeder
        window.saveCustomTitle = function(newTitle) {
            let trimmedTitle = newTitle.trim();
            if (trimmedTitle === "") {
                trimmedTitle = "MASA TENİSİ LİGİ"; // Boş bırakılırsa varsayılanı kullan
            }
            customTitle = trimmedTitle;
            saveState();
            updateAppTitle();
            showMessage("Uygulama başlığı başarıyla güncellendi.", 'success', 2000);
        }

        // ---------- YARDIMCI VE UTILITY FONKSİYONLAR ----------

        function showMessage(message, type = 'success', duration = 3000) {
            const el = document.getElementById('settings-message'); 
            if (!el) return; 

            el.textContent = message;
            el.className = `text-sm text-center font-medium py-2 rounded ${type === 'success' ? 'text-green-400 bg-green-900/30' : 'text-red-400 bg-red-900/30'}`;
            
            setTimeout(() => { 
                el.textContent = ''; 
                el.className = 'text-sm text-center font-medium'; 
            }, duration);
        }
        
        function generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ---------- MODAL FONKSİYONLARI ----------
        
        window.showConfirmationModal = function(title, message, callback, confirmText = "Onayla") {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-button').textContent = confirmText;
            
            currentCallback = callback;
            modal.classList.remove('hidden');
        }

        window.closeModal = function(result = false) {
            document.getElementById('confirmation-modal').classList.add('hidden');
            if (currentCallback) {
                currentCallback(result);
                currentCallback = null; 
            }
        }
        
        window.showSettingsModal = function() {
            renderPlayerSettings(); 
            updateAppTitle(); // Mod değiştirme butonlarının görünürlüğünü ayarlamak ve başlık inputunu doldurmak için
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        window.closeSettingsModal = function() {
            document.getElementById('settings-modal').classList.add('hidden');
        }
        
        // ---------- FİKSTÜR VE SKOR İŞLEMLERİ ----------

        // Diziyi karıştırmak için Fisher-Yates (Knuth) algoritması
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // Genel Fikstür oluşturucu (Tekler veya Çiftler için)
        function generateFixtures(useTeams = false) {
            const entityList = useTeams ? teams.map(t => t.name) : players.map(p => p.name);
            
            if (entityList.length < 2) {
                 showMessage("Hata: Fikstür çekmek için en az 2 takım/canavar eklenmelidir.", 'error');
                 matches = [];
                 totalRounds = 0;
                 saveState();
                 renderFixtures();
                 renderStandings();
                 return;
            }

            matches = []; 

            let tempEntityNames = shuffle([...entityList]);
            
            const isOdd = tempEntityNames.length % 2 !== 0;
            if (isOdd) {
                tempEntityNames.push(null); // BYE için null ekle
            }
            const n = tempEntityNames.length; 
            
            totalRounds = n - 1; 
            currentRound = 1; 

            for (let round = 0; round < totalRounds; round++) {
                
                for (let i = 0; i < n / 2; i++) {
                    const p1 = tempEntityNames[i];
                    const p2 = tempEntityNames[n - 1 - i];

                    if (p1 === null && p2 === null) continue; 
                    
                    // BYE durumu
                    if (p1 === null || p2 === null) {
                         const byeEntity = p1 === null ? p2 : p1;
                         matches.push({
                            id: generateUniqueId(),
                            round: round + 1,
                            home: byeEntity,
                            away: null, // Bay (BYE)
                            homeScore: null,
                            awayScore: null
                        });
                        continue;
                    }


                    // Ev/Deplasman rastgele belirlenir
                    const isSwapped = Math.random() > 0.5;
                    const home = isSwapped ? p2 : p1;
                    const away = isSwapped ? p1 : p2;

                    matches.push({
                        id: generateUniqueId(),
                        round: round + 1,
                        home: home,
                        away: away,
                        homeScore: null,
                        awayScore: null
                    });
                }
                
                // Rotasyon Mantığı (Bay oyuncuyu sabit tutma)
                if (n > 2) { 
                    // n tek ise, son eleman (null) sabit kalmalı, diğerleri dönmeli
                    const rotatingPart = tempEntityNames.slice(0, n - 1);
                    const lastRotating = rotatingPart.pop(); 
                    rotatingPart.unshift(lastRotating); 
                    tempEntityNames = [...rotatingPart, tempEntityNames[n-1]];
                }
            }
            
            saveState();
            renderFixtures();
            renderStandings();
            
            const message = useTeams ? "Yeni Çiftler Ligi fikstürü başarıyla çekildi!" : "Yeni Tekler Ligi fikstürü başarıyla çekildi!";
            showMessage(message, 'success');
        }

        // Çiftli Turnuva Takımlarını Kurar ve Fikstür Çeker
        window.generateDoublesTeamsAndFixtures = function() {
            if (players.length < 4 || players.length % 2 !== 0) {
                showMessage("Hata: Çiftli turnuva için çift sayıda (min 4) canavar gereklidir.", 'error', 6000);
                return;
            }

            // 1. Tekler puan durumunu hesapla (Takımları kurmak için sıralama lazım)
            const sortedSingles = getStandingsData(false); 
            const n = sortedSingles.length;

            teams = [];
            
            // 2. Çapraz Eşleştirme (1. vs sonuncu, 2. vs sondan bir önceki...)
            for (let i = 0; i < n / 2; i++) {
                const p1 = sortedSingles[i]; 
                const p2 = sortedSingles[n - 1 - i];

                const teamName = `${p1.name} & ${p2.name}`;
                
                teams.push({
                    id: generateUniqueId(),
                    name: teamName,
                    player1Name: p1.name, 
                    player2Name: p2.name
                });
            }

            // 3. Modu Çiftler'e çevir ve Fikstürü çek
            isDoublesMode = true;
            updateAppTitle(); 
            generateFixtures(true); // Takımları kullanarak fikstür çek

            closeSettingsModal();
        }
        
        // Tekler Ligi'ne geri dönmek
        window.startSinglesTournamentConfirmation = function() {
            if (players.length < 2) {
                showMessage("Tekler Ligi'ne dönmek için en az 2 canavar olmalıdır.", 'error', 5000);
                return;
            }

            showConfirmationModal(
                "Tekler Ligi'ne Geri Dönüş Onayı",
                `Tüm Çiftler Ligi skorları silinecek, takımlar dağıtılacak ve mevcut canavarlar arasında yeni bir Tekler Ligi fikstürü oluşturulacaktır. Emin misiniz?`,
                (confirmed) => {
                    if (confirmed) {
                        isDoublesMode = false;
                        teams = []; // Takımları temizle

                        // Yeni tekler fikstürü çek
                        generateFixtures(false); 

                        // Başlık ve UI güncellemeleri
                        updateAppTitle();
                        closeSettingsModal();
                    }
                },
                "Tekler Moduna Geç"
            );
        }
        
        window.updateScore = function(matchId, type, value) {
            const scoreValue = value === '' ? null : parseInt(value);
            const matchIndex = matches.findIndex(m => m.id === matchId);
            
            if (matchIndex !== -1) {
                matches[matchIndex][type] = scoreValue;
                saveState();
                renderStandings(); 
            }
        }
        
        window.changeRound = function(direction) {
            const newRound = currentRound + direction;
            if (newRound >= 1 && newRound <= totalRounds) {
                currentRound = newRound;
                localStorage.setItem('currentRound', currentRound);
                renderFixtures();
            }
        }


        // ---------- PUAN DURUMU VE FİKSTÜR RENDER ETME ----------
        
        function getStandingsData(useTeams) {
            const entityList = useTeams ? teams : players;
            const stats = {};
            
            entityList.forEach(e => {
                stats[e.name] = { name: e.name, played: 0, won: 0, drawn: 0, lost: 0, gf: 0, ga: 0, points: 0 };
            });

            matches.forEach(m => {
                // Bay (BYE) maçlarını atla
                if (m.away === null) return;
                
                // Eğer maç, aktif moddaki (Tekler/Çiftler) oyuncular/takımlar arasındaysa hesapla
                const entityNames = entityList.map(e => e.name);
                if (!entityNames.includes(m.home) || !entityNames.includes(m.away)) {
                    return; 
                }

                if (m.homeScore !== null && m.awayScore !== null) {
                    const h = m.home;
                    const a = m.away;
                    const hs = m.homeScore;
                    const as = m.awayScore;

                    // Eğer istatistik nesneleri yoksa (Tekler modu aktifken Çiftler maçı skoru hesaplanmaz vs)
                    if (!stats[h] || !stats[a]) return;

                    stats[h].played++;
                    stats[a].played++;
                    
                    stats[h].gf += hs;
                    stats[a].gf += as;
                    stats[h].ga += as;
                    stats[a].ga += hs;

                    // PUANLAMA LOGİĞİ: Puan = Attığı Gol Sayısı (GF)
                    stats[h].points += hs; 
                    stats[a].points += as;

                    if (hs > as) { stats[h].won++; stats[a].lost++; } 
                    else if (as > hs) { stats[a].won++; stats[h].lost++; } 
                    else { stats[h].drawn++; stats[a].drawn++; }
                }
            });

            // Sıralama: Puan (büyükten küçüğe), Averaj (büyükten küçüğe), Attığı Gol (büyükten küçüğe)
            sortedPlayers = Object.values(stats).sort((a, b) => {
                const gdA = a.gf - a.ga;
                const gdB = b.gf - b.ga;
                
                if (b.points !== a.points) return b.points - a.points; 
                if (gdB !== gdA) return gdB - gdA;
                return b.gf - a.gf;
            });
            
            return sortedPlayers;
        }

        function renderStandings() {
            const sorted = getStandingsData(isDoublesMode);

            const tbody = document.getElementById('standings-body');
            tbody.innerHTML = '';
            
            sorted.forEach((team, index) => {
                const gd = team.gf - team.ga;
                const gdStr = gd > 0 ? `+${gd}` : gd;
                
                let rankClass = "text-slate-500";
                let rankIcon = index + 1;
                
                if (index === 0) { rankClass = "text-yellow-400 font-bold"; rankIcon = '<i class="fas fa-skull"></i>'; } 
                else if (index === 1) { rankClass = "text-gray-300 font-bold"; }
                else if (index === 2) { rankClass = "text-amber-700 font-bold"; }

                // Çiftler modunda oyuncu maçları gösterilmez (sadece Takım olarak var)
                const entityNameHtml = isDoublesMode 
                    ? `<span class="font-medium text-white">${team.name}</span>`
                    : `<span class="font-medium text-white">${team.name}</span>`; // Tekler modunda da detayı kaldırdık

                const row = `
                    <tr class="transition-colors ${index % 2 === 0 ? 'bg-slate-800/30' : ''}">
                        <td class="p-4 text-center font-mono ${rankClass}">${rankIcon}</td>
                        <td class="p-4 font-medium text-white flex items-center gap-3">
                            <div class="w-1 h-6 rounded-r ${index === 0 ? 'bg-yellow-400' : 'bg-blue-600'}"></div>
                            ${entityNameHtml}
                        </td>
                        <td class="p-4 text-center font-mono text-slate-300">${team.played}</td>
                        <td class="p-4 text-center font-mono text-green-400 hidden sm:table-cell">${team.won}</td>
                        <td class="p-4 text-center font-mono text-slate-400 hidden sm:table-cell">${team.drawn}</td>
                        <td class="p-4 text-center font-mono text-red-400 hidden sm:table-cell">${team.lost}</td>
                        <td class="p-4 text-center font-mono text-white hidden sm:table-cell">${team.gf}</td>
                        <td class="p-4 text-center font-mono hidden md:table-cell text-slate-400">${team.ga}</td>
                        <td class="p-4 text-center font-mono font-bold text-slate-200">${gdStr}</td>
                        <td class="p-4 text-center font-bold text-xl text-white bg-blue-600/20 shadow-inner">${team.points}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function renderFixtures() {
            const container = document.getElementById('fixtures-container');
            const roundTitleEl = document.getElementById('round-title');
            const prevBtn = document.getElementById('prev-round-btn');
            const nextBtn = document.getElementById('next-round-btn');
            
            container.innerHTML = '';
            
            const entityCount = isDoublesMode ? teams.length : players.length;

            if (totalRounds === 0 || entityCount < 2) {
                const messageHtml = `<div class="text-center p-8 bg-slate-900/50 rounded-xl">
                       <i class="fas fa-user-times text-4xl text-red-500 mb-3"></i>
                       <p class="text-lg font-semibold text-white">Yeterli canavar/takım yok veya fikstür çekilmedi.</p>
                       <p class="text-slate-400 text-sm">Lütfen Ayarlar ikonuna tıklayarak canavar ekleyin ve fikstür çekin.</p>
                   </div>`;
                container.innerHTML = messageHtml;
                roundTitleEl.textContent = "Fikstür Yok";
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            const currentRoundMatches = matches.filter(m => m.round === currentRound);
            
            // Haftalık Navigasyon Güncellemesi
            roundTitleEl.textContent = `${currentRound}. Hafta`;
            prevBtn.disabled = currentRound === 1;
            nextBtn.disabled = currentRound === totalRounds;

            let matchesHtml = '<div class="grid gap-3 md:grid-cols-2">';
            let byeEntity = null;

            currentRoundMatches.forEach(m => {
                
                // BYE maçı
                if (m.away === null) {
                    byeEntity = m.home;
                    return; 
                }

                const isPlayed = m.homeScore !== null && m.awayScore !== null;
                const borderClass = isPlayed ? 'border-green-500/30 bg-green-900/10' : 'border-slate-700 bg-slate-800/40';

                const scoreInputs = `
                    <input type="number" min="0" placeholder="-" 
                        class="w-10 h-10 bg-slate-900 text-center rounded border border-slate-600 focus:border-blue-500 outline-none text-white font-mono text-lg"
                        value="${m.homeScore !== null ? m.homeScore : ''}"
                        onchange="updateScore('${m.id}', 'homeScore', this.value)"
                    >
                    <span class="score-separator text-slate-500 font-bold">:</span>
                    <input type="number" min="0" placeholder="-" 
                        class="w-10 h-10 bg-slate-900 text-center rounded border border-slate-600 focus:border-blue-500 outline-none text-white font-mono text-lg"
                        value="${m.awayScore !== null ? m.awayScore : ''}"
                        onchange="updateScore('${m.id}', 'awayScore', this.value)"
                    >
                `;
                
                matchesHtml += `
                    <div class="flex items-center justify-between p-3 rounded-lg border ${borderClass} transition-all hover:bg-slate-700">
                        <!-- Home Entity (Oyuncu/Takım) -->
                        <div class="flex-1 text-right pr-3 text-sm font-semibold truncate text-slate-300">
                            ${m.home}
                        </div>
                        
                        <div class="score-container flex items-center gap-2">
                            ${scoreInputs}
                        </div>

                        <!-- Away Entity (Oyuncu/Takım) -->
                        <div class="flex-1 text-left pl-3 text-sm font-semibold truncate text-slate-300">
                            ${m.away}
                        </div>
                    </div>
                `;
            });

            matchesHtml += '</div>';

            // BYE (Bay) mesajı ekleme
            if (byeEntity) {
                 matchesHtml += `
                     <div class="mt-6 text-center p-3 rounded-lg bg-yellow-900/30 border border-yellow-700 text-yellow-300 font-medium">
                         <i class="fas fa-user-alt-slash mr-2"></i> ${byeEntity} bu hafta BAY (dinleniyor).
                     </div>
                 `;
            }

            container.innerHTML = matchesHtml;
        }
        
        // ---------- OYUNCU YÖNETİMİ ----------

        function renderPlayerSettings() {
            const container = document.getElementById('player-list-container');
            const playerCountElement = document.getElementById('player-count-display');
            const warningElement = document.getElementById('player-warning');
            
            container.innerHTML = '';
            playerCountElement.textContent = `Mevcut Canavarlar (${players.length})`;
            
            if (players.length % 2 !== 0 || players.length < 4) {
                 warningElement.classList.remove('hidden');
            } else {
                 warningElement.classList.add('hidden');
            }
            
            // Başlık input'unu güncel tut
            document.getElementById('app-custom-title').value = customTitle;

            players.forEach(player => {
                
                const li = `
                    <li class="flex justify-between items-center bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                        <div class="flex items-center gap-3">
                            <span class="font-medium text-white">${player.name}</span>
                        </div>
                        <button onclick="removePlayerConfirmation('${player.id}', '${player.name.replace(/'/g, "\\'")}')" class="text-red-400 hover:text-red-500 transition-colors">
                            <i class="fas fa-minus-circle"></i> Çıkar
                        </button>
                    </li>
                `;
                container.innerHTML += li;
            });
        }

        window.handleAddPlayer = function() {
            const inputName = document.getElementById('new-player-name');
            let name = inputName.value.trim();
            
            if (!name) {
                showMessage("Lütfen bir canavar adı girin.", 'error'); 
                return;
            }

            // İsim formatlama
            name = name.toLowerCase().split(' ').map((s) => s.charAt(0).toUpperCase() + s.substring(1)).join(' ');

            if (players.some(p => p.name === name)) {
                showMessage(`${name} zaten depoda var.`, 'error');
                return;
            }
            
            if (isDoublesMode) {
                 showMessage("Hata: Çiftler modunda canavar ekleyemezsiniz. Önce Tekler Ligi'ne geçmeniz gerekir.", 'error', 5000);
                 return;
            }
            
            players.push({ id: generateUniqueId(), name: name });
            
            saveState();
            inputName.value = ''; 
            renderPlayerSettings();

            if (matches.length > 0) {
                showConfirmationModal(
                    "Fikstür Güncelleme",
                    `Canavar listesi değişti. Yeni fikstür oluşturulsun mu? (Mevcut skorlar silinecektir)`,
                    (confirmed) => {
                        if (confirmed) {
                            generateFixtures(false);
                            closeSettingsModal();
                        } else {
                            showMessage(`${name} depoya eklendi.`, 'success');
                        }
                    }
                );
            } else {
                showMessage(`${name} depoya eklendi.`, 'success');
            }
        }

        window.removePlayerConfirmation = function(playerId, name) {
            if (players.length <= 1) {
                showMessage("Depoda en az 1 canavar kalmalıdır.", 'error');
                return;
            }

            showConfirmationModal(
                "Canavar Çıkarma Onayı",
                `${name} adlı canavarı depodan (ligden) çıkarmak istediğinizden emin misiniz? Fikstür yenilenecek ve tüm skorlar silinecektir.`,
                (confirmed) => {
                    if (confirmed) {
                        players = players.filter(p => p.id !== playerId);
                        teams = []; // Takımları da temizle
                        isDoublesMode = false;
                        updateAppTitle();

                        saveState();
                        generateFixtures(false); // Tekler fikstürünü otomatik yenile
                        renderPlayerSettings();
                    }
                },
                "Çıkar ve Sıfırla"
            );
        }

        window.resetFixturesConfirmation = function() {
            const entityType = isDoublesMode ? "takım" : "canavar";
            const entityCount = isDoublesMode ? teams.length : players.length;

            if (entityCount < 2) {
                showMessage(`Hata: Fikstür çekmek için en az 2 ${entityType} olmalıdır. Lütfen canavar ekleyin.`, 'error');
                return;
            }
            
            showConfirmationModal(
                isDoublesMode ? "Çiftler Fikstürünü Yenile" : "Tekler Ligi Fikstürünü Yenile",
                `Tüm maç skorları silinecek ve mevcut ${entityCount} ${entityType} listesine göre yepyeni, rastgele bir fikstür çekilecektir. Emin misiniz?`,
                (confirmed) => {
                    if (confirmed) {
                        generateFixtures(isDoublesMode);
                    }
                },
                "Fikstür Çek"
            );
        }
        
        window.startDoublesTournamentConfirmation = function() {
             if (players.length < 4 || players.length % 2 !== 0) {
                showMessage("Hata: Çiftli turnuva için çift sayıda (min 4) canavar gereklidir. Lütfen canavar sayısını ayarlayın.", 'error', 6000);
                return;
            }

            showConfirmationModal(
                "Çiftli Turnuvaya Geçiş Onayı",
                `Tüm mevcut skorlar silinecek. Mevcut sıralamaya göre takımlar kurulacak ve yeni Çiftler Ligi fikstürü oluşturulacaktır. Emin misiniz?`,
                (confirmed) => {
                    if (confirmed) {
                        generateDoublesTeamsAndFixtures();
                    }
                },
                "Çiftler Moduna Geç"
            );
        }

        window.resetLeagueConfirmation = function() {
            showConfirmationModal(
                "TÜM VERİLERİ SIFIRLA",
                "DİKKAT! Tüm canavarlar, takımlar, skorlar ve fikstür yerel depolamadan silinecek. Uygulama fabrika ayarlarına dönecek. Emin misin?",
                (confirmed) => {
                    if (confirmed) {
                        localStorage.clear();
                        location.reload(); 
                    }
                },
                "Tümünü Sil"
            );
        }
        
        window.showTab = function(tabName) {
            
            document.getElementById('tab-standings').classList.add('hidden');
            document.getElementById('tab-fixtures').classList.add('hidden');

            ['standings', 'fixtures'].forEach(tab => {
                const btn = document.getElementById('btn-' + tab);
                if (btn) {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('text-slate-400', 'hover:bg-slate-700');
                }
            });

            document.getElementById('tab-' + tabName).classList.remove('hidden');
            const activeBtn = document.getElementById('btn-' + tabName);
            if (activeBtn) {
                activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                activeBtn.classList.remove('text-slate-400', 'hover:bg-slate-700');
            }
            
            if (tabName === 'fixtures') {
                renderFixtures();
            } else if (tabName === 'standings') {
                renderStandings();
            }
        }
        
        // Uygulamayı Başlat
        window.initApp = function() {
            loadData();
            if (totalRounds > 0 && currentRound > totalRounds) {
                currentRound = totalRounds; 
            } else if (totalRounds === 0) {
                 currentRound = 1;
            }
            showTab('standings'); 
        }

    </script>
</body>
</html>

