<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Lig Uygulaması - Supabase Bağlantılı</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial; margin: 20px; }
input, select, button { padding: 6px; margin: 4px; }
.container { max-width: 900px; margin: auto; }
.player-box, .match-box, .list-box { border: 1px solid #aaa; padding: 12px; margin-bottom: 16px; }
</style>

<script>
/* --------------------------- SUPABASE CLIENT --------------------------- */

const supabaseUrl = "BURAYA_KENDI_URLIN_GELECEK";
const supabaseKey = "BURAYA_ANON_KEY_GELECEK";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

/* --------------------------- GLOBAL STATE --------------------------- */

let players = [];
let matches = [];
let totalRounds = 0;

/* --------------------------- LOAD DATA --------------------------- */

async function loadDataFromDB() {
    const { data: playerRows } = await supabase.from("players").select("*");
    const { data: matchRows } = await supabase.from("matches").select("*");

    players = playerRows || [];
    matches = matchRows || [];

    players.sort((a,b)=>a.name.localeCompare(b.name,'tr'));

    matches.sort((a,b)=>{
        if(a.round!==b.round) return a.round - b.round;
        return a.home.localeCompare(b.home,'tr');
    });

    if(matches.length>0){
        totalRounds = Math.max(...matches.map(m=>m.round));
    } else totalRounds = 0;

    renderPlayers();
    renderMatches();
    renderStandings();
}

/* --------------------------- SAVE DATA --------------------------- */

async function savePlayersToDB() {
    await supabase.from("players").delete().neq("id","");
    await supabase.from("players").insert(players);
}

async function saveMatchesToDB() {
    await supabase.from("matches").delete().neq("id","");
    await supabase.from("matches").insert(matches);
}

/* --------------------------- PLAYER FUNCTIONS --------------------------- */

function addPlayer() {
    const name = document.getElementById("playerName").value.trim();
    if(!name) return;

    const id = crypto.randomUUID();
    players.push({ id, name });
    players.sort((a,b)=>a.name.localeCompare(b.name,'tr'));

    savePlayersToDB();
    renderPlayers();

    document.getElementById("playerName").value="";
}

function renderPlayers() {
    const box = document.getElementById("playerList");
    box.innerHTML = "";

    players.forEach(p=>{
        const row = document.createElement("div");
        row.textContent = p.name;
        box.appendChild(row);
    });

    fillPlayerSelects();
}

function fillPlayerSelects(){
    const h = document.getElementById("homePlayer");
    const a = document.getElementById("awayPlayer");

    h.innerHTML = "";
    a.innerHTML = "";

    players.forEach(p=>{
        const op1=document.createElement("option");
        op1.value=p.id; op1.textContent=p.name;
        h.appendChild(op1);

        const op2=document.createElement("option");
        op2.value=p.id; op2.textContent=p.name;
        a.appendChild(op2);
    });
}

/* --------------------------- MATCH FUNCTIONS --------------------------- */

function addMatch() {
    const round = parseInt(document.getElementById("round").value);
    const home = document.getElementById("homePlayer").value;
    const away = document.getElementById("awayPlayer").value;
    const homeScore = parseInt(document.getElementById("homeScore").value);
    const awayScore = parseInt(document.getElementById("awayScore").value);

    if(home===away) return alert("Aynı oyuncu seçilemez.");

    const id = crypto.randomUUID();

    matches.push({ id, round, home, away, homeScore, awayScore });

    matches.sort((a,b)=>{
        if(a.round!==b.round) return a.round - b.round;
        return a.home.localeCompare(b.home,'tr');
    });

    totalRounds = Math.max(totalRounds, round);

    saveMatchesToDB();
    renderMatches();
    renderStandings();
}

function renderMatches() {
    const box = document.getElementById("matchList");
    box.innerHTML = "";

    matches.forEach(m=>{
        const hrName = players.find(x=>x.id===m.home)?.name || "?";
        const awName = players.find(x=>x.id===m.away)?.name || "?";

        const row=document.createElement("div");
        row.textContent = `${m.round}. Tur: ${hrName} ${m.homeScore} - ${m.awayScore} ${awName}`;
        box.appendChild(row);
    });
}

/* --------------------------- STANDINGS --------------------------- */

function calculateStandings() {
    const table = {};

    players.forEach(p=>{
        table[p.id] = { name:p.name, pts:0, played:0, diff:0, win:0, draw:0, loss:0 };
    });

    matches.forEach(m=>{
        const home = table[m.home];
        const away = table[m.away];

        home.played++; away.played++;

        home.diff += (m.homeScore - m.awayScore);
        away.diff += (m.awayScore - m.homeScore);

        if(m.homeScore > m.awayScore){
            home.pts+=3; home.win++; away.loss++;
        } else if(m.homeScore < m.awayScore){
            away.pts+=3; away.win++; home.loss++;
        } else {
            home.pts++; away.pts++; home.draw++; away.draw++;
        }
    });

    return Object.values(table).sort((a,b)=>{
        if(b.pts !== a.pts) return b.pts - a.pts;
        return b.diff - a.diff;
    });
}

function renderStandings() {
    const list = calculateStandings();
    const box = document.getElementById("standings");
    box.innerHTML="";

    list.forEach((t,i)=>{
        const row = document.createElement("div");
        row.textContent = `${i+1}. ${t.name} - Puan: ${t.pts} | Averaj: ${t.diff}`;
        box.appendChild(row);
    });
}

/* --------------------------- INIT --------------------------- */

window.onload = loadDataFromDB;
</script>
</head>

<body>
<div class="container">

<div class="player-box">
<h3>Oyuncu Ekle</h3>
<input id="playerName" placeholder="Oyuncu adı">
<button onclick="addPlayer()">Ekle</button>
<div id="playerList"></div>
</div>

<div class="match-box">
<h3>Maç Ekle</h3>
Tur: <input id="round" type="number" min="1" value="1">
<br>
Ev sahibi: <select id="homePlayer"></select>
<br>
Deplasman: <select id="awayPlayer"></select>
<br>
Ev Skor: <input id="homeScore" type="number" value="0">
Deplasman Skor: <input id="awayScore" type="number" value="0">
<br>
<button onclick="addMatch()">Maç Kaydet</button>
<div id="matchList"></div>
</div>

<div class="list-box">
<h3>Puan Durumu</h3>
<div id="standings"></div>
</div>

</div>
</body>
</html>